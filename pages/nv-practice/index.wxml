<custom-nav subtitle="{{displayCategory}}" progress="{{words.length > 0 ? (currentIndex + 1) + ' / ' + words.length : ''}}" theme="light" bind:settings="openSettings" showSettingsTooltip="{{showSettingsTooltip}}" settingsTooltipText="{{settingsTooltipText}}"></custom-nav>

<view class="container {{isKeyboardOpen ? 'keyboard-open' : ''}} {{showSettingsModal ? 'modal-open' : ''}}" style="padding-top: {{statusBarHeight + navBarHeight + 10}}px;" bindtap="focusHiddenInput">
  <input class="hidden-input" value="{{hiddenInputValue}}" focus="{{inputFocus}}" bindinput="onHiddenInput" bindblur="onHiddenInputBlur" maxlength="-1" />

  <!-- 每日一句入口 -->
  <view class="daily-sentence-entry" bindtap="openDailySentence">
    <view class="entry-left">
      <image src="/assets/icons/danmaku.svg" class="entry-icon" mode="aspectFit" />
      <text class="entry-title">每日一句</text>
    </view>
    <view class="entry-right">
      <text class="entry-source">{{dailySentenceEntrySource || ''}}</text>
      <text class="entry-arrow">›</text>
    </view>
  </view>

  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- Main Card -->
  <view class="card-container {{isKeyboardOpen ? 'keyboard-open' : ''}}" wx:elif="{{currentWord}}">
    
    <view class="card-stack {{prevWordInfo ? 'has-prev' : ''}}">
      <!-- Previous Word Indicator (Ticket Style) -->
      <view class="prev-word-ticket-wrap {{prevWordInfo ? 'show' : ''}}" wx:if="{{prevWordInfo}}">
          <view class="prev-tag {{prevWordInfo.isCorrect ? 'correct' : 'wrong'}}">PREV</view>
          <view class="prev-content">
              <text class="prev-kr">{{prevWordInfo.word}}</text>
              <text class="prev-cn">{{prevWordInfo.meaning}}</text>
          </view>
      </view>

      <view class="card {{isError ? 'shake' : ''}}">
        <!-- Card Top: Mode & Actions -->
        <view class="card-top-bar">
            <view class="top-left-group">
                <view class="focus-mode-btn" bindtap="toggleFocusMode">F</view>
                <text class="mode-badge">Practice</text>
            </view>
            <view class="card-actions">
                <view class="action-icon" bindtap="playWordAudio" hover-class="none">
                    <image src="/assets/icons/volume.svg" style="width: 24px; height: 24px;" mode="aspectFit" />
                </view>
                <view class="action-icon" bindtap="removeCurrentFromMistakes" wx:if="{{settings.category === 'Mistakes (错题本)'}}">
                    <text style="font-size: 12px; color: #ef4444;">移出</text>
                </view>
            </view>
        </view>

        <!-- Card Body -->
        <view class="card-body">
            <view class="nav-arrow left" bindtap="prevWord">
                <text>‹</text>
            </view>
            
            <view class="word-content" bindtap="showWordDetail">
                <view class="word-tooltip" wx:if="{{showWordTooltip}}" catchtap="dismissWordTooltip">
                    <text>点击单词可查看例句</text>
                    <view class="tooltip-arrow"></view>
                </view>

                <!-- Meaning (Chinese) -->
                <view class="meaning-container {{settings.cardShowMeaning ? '' : 'keep-space-hidden'}}">
                  <text class="meaning {{meaningIsSmall || currentWord.meaning.length > 7 ? 'meaning-small' : ''}}">{{currentWord.meaning}}</text>
                </view>

                <!-- Korean Word Slots -->
                <view id="nvLineMeasure" class="nv-text-line nv-text-line-measure">
                  <block wx:for="{{measureChars}}" wx:key="index">
                    <text class="nv-char text-gray">{{item}}</text>
                  </block>
                </view>

                <view wx:if="{{useLegacyWrapMode}}" class="nv-legacy-line {{(settings.cardShowWord || typingState.userInput.length > 0 || helpReveal) ? '' : 'keep-space-hidden'}}">
                  <block wx:if="{{isWordVisible || typingState.userInput.length > 0 || helpReveal}}">
                    <block wx:for="{{legacyDisplayChars}}" wx:key="index">
                      <text
                        class="nv-char legacy-char {{item.isCenter ? 'legacy-center' : ''}} {{item.status === 'done' ? 'text-green' : (item.status === 'active' ? 'text-yellow' : 'text-gray')}}"
                        style="{{item.status === 'active' ? 'background: linear-gradient(to right, #34d399 ' + item.progress + '%, #94a3b8 ' + item.progress + '%); -webkit-background-clip: text; color: transparent;' : ''}}"
                      >{{item.char}}</text>
                    </block>
                  </block>
                </view>

                <view wx:else class="nv-text-line {{(settings.cardShowWord || typingState.userInput.length > 0 || helpReveal) ? '' : 'keep-space-hidden'}}">
                  <block wx:if="{{isWordVisible || typingState.userInput.length > 0 || helpReveal}}">
                    <block wx:for="{{displayChars}}" wx:key="index">
                      <text
                        class="nv-char {{item.status === 'done' ? 'text-green' : (item.status === 'active' ? 'text-yellow' : 'text-gray')}}"
                        style="{{item.status === 'active' ? 'background: linear-gradient(to right, #34d399 ' + item.progress + '%, #94a3b8 ' + item.progress + '%); -webkit-background-clip: text; color: transparent;' : ''}}"
                      >{{item.char}}</text>
                    </block>
                  </block>
                </view>
            </view>

            <view class="nav-arrow right" bindtap="nextWord">
                <text>›</text>
            </view>
        </view>
      </view>
    </view>
  </view>

  <!-- Empty State -->
  <view class="empty-state" wx:else>
      <text>No words found.</text>
      <button bindtap="loadWords" class="retry-btn">Retry</button>
  </view>

  <!-- Keyboard -->
  <view class="keyboard-wrapper {{isKeyboardOpen ? 'open' : 'closed'}}">
      <view class="keyboard-header-row">
        <view class="keyboard-header-left">
          <view class="keyboard-icon-btn" bindtap="onHelpReveal">
            <image src="/assets/tabbar/re_eye.png" class="keyboard-action-icon" mode="aspectFit" />
          </view>
          <block wx:if="{{settings.category === 'Mistakes (错题本)'}}">
            <view class="keyboard-mistake-pill">
              <image src="/assets/tabbar/re_错题本.png" class="keyboard-action-icon" mode="aspectFit" />
              <text class="keyboard-pill-text">{{currentIndex + 1}}/{{words.length}}</text>
            </view>
          </block>
        </view>

        <view class="keyboard-header-center" bindtap="toggleKeyboard">
          <view class="keyboard-handle-bar"></view>
        </view>

        <view class="keyboard-header-right">
          <block wx:if="{{settings.category !== 'Mistakes (错题本)'}}">
            <view class="keyboard-icon-btn" bindtap="addToMistakes">
              <image src="/assets/tabbar/re_错题本.png" class="keyboard-action-icon" mode="aspectFit" />
            </view>
          </block>
          <view class="keyboard-icon-btn keyboard-close-btn" bindtap="toggleKeyboard">
            <text class="keyboard-close-text">⌄</text>
          </view>
        </view>
      </view>

      <keyboard 
        id="keyboard"
        theme="light"
        nextKeyToPress="{{typingState.nextKey === 'SPACE' ? 'SPACE' : (settings.enableKeyboardHint ? (typingState.nextKey || '') : '')}}"
        isShiftActive="{{typingState.isShiftActive}}"
        visualMode="{{settings.keyboardVisualMode}}"
        bind:keyPress="onKeyPress"
      />
  </view>

  <view class="keyboard-expand-fab" wx:if="{{!isKeyboardOpen}}" bindtap="toggleKeyboard">
    <text class="keyboard-expand-icon">⌃</text>
  </view>

  <view class="guide-bubble" wx:if="{{showGuideBubble}}" bindtap="onGuideBubbleClick">
    <text>点击唤起键盘</text>
    <view class="guide-arrow"></view>
  </view>

  <!-- Word Detail Modal -->
  <view class="detail-overlay {{showDetailModal ? 'show' : ''}} {{isKeyboardOpen ? 'keyboard-open' : ''}}" bindtap="closeDetailModal">
    <view class="detail-card" catchtap="playSentenceAudio">
      <view class="detail-header">
        <text class="detail-title">例句学习</text>
        <view class="detail-close" catchtap="closeDetailModal">×</view>
      </view>
      <scroll-view scroll-y class="detail-body">
        <view class="detail-section">
            <view class="detail-row">
                <view class="detail-label-row">
                  <text class="detail-label">例句</text>
                  <image src="../../assets/icons/volume.svg" class="detail-audio-icon" />
                </view>
                <text class="detail-text korean">{{currentWord.example_sentence || '暂无例句'}}</text>
            </view>
        </view>
        <view class="detail-section" wx:if="{{currentWord.sentence_translation}}">
             <view class="detail-row">
                <text class="detail-label">释义</text>
                <text class="detail-text chinese">{{currentWord.sentence_translation}}</text>
            </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- Settings Modal -->
  <view class="modal-overlay {{showSettingsModal ? 'show' : ''}}" bindtap="closeSettings">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text class="modal-title">设置</text>
      </view>
      
      <scroll-view scroll-y class="modal-body">
        <view class="setting-section">
          <view class="section-title">词书</view>
          <picker mode="selector" range="{{categories}}" value="{{categoryPickerIndex}}" bindchange="onCategoryPickerChange">
            <view class="category-item picker-item">
              <text class="picker-label">选择词书</text>
              <view class="picker-right">
                <text class="picker-value">{{settings.category}}</text>
                <text class="picker-arrow">›</text>
              </view>
            </view>
          </picker>
        </view>

        <view class="setting-section" wx:if="{{showTopikSub}}">
          <view class="section-title">选择二级分类</view>
          <picker mode="selector" range="{{topikLevels}}" value="{{topikLevelPickerIndex}}" bindchange="onTopikLevelPickerChange">
            <view class="category-item picker-item">
              <text class="picker-label">TOPIK 等级</text>
              <view class="picker-right">
                <text class="picker-value">TOPIK {{settings.topikLevel}}</text>
                <text class="picker-arrow">›</text>
              </view>
            </view>
          </picker>

          <view class="topik-session" wx:if="{{topikSessions.length}}">
            <text class="picker-label">Session</text>
            <scroll-view scroll-x class="topik-session-scroll" show-scrollbar="{{false}}">
              <view class="topik-session-row">
                <block wx:for="{{topikSessions}}" wx:key="*this">
                  <view class="topik-session-chip {{settings.topikSession === item ? 'active' : ''}}" bindtap="selectTopikSession" data-session="{{item}}">
                    <text>{{item}}</text>
                  </view>
                </block>
              </view>
            </scroll-view>
          </view>
        </view>

        <view class="setting-section" wx:if="{{showYonseiSub}}">
          <view class="section-title">选择二级分类</view>
          <picker mode="selector" range="{{yonseiLessonOptions}}" value="{{yonseiLessonPickerIndex}}" bindchange="onYonseiLessonPickerChange">
            <view class="category-item picker-item">
              <text class="picker-label">课次 </text>
              <view class="picker-right">
                <text class="picker-value">{{yonseiLessonDisplay}}</text>
                <text class="picker-arrow">›</text>
              </view>
            </view>
          </picker>
        </view>

        <view class="setting-section">
          <text class="section-title">显示模式</text>
          <view class="mode-toggles">
            <view class="mode-btn {{settings.practiceMode === 'study' ? 'active' : ''}}" bindtap="updateSetting" data-key="practiceMode" data-value="study">
              <text>常驻显示</text>
              <text class="mode-btn-sub">Always Visible</text>
            </view>
            <view class="mode-btn {{settings.practiceMode === 'flash' ? 'active' : ''}}" bindtap="updateSetting" data-key="practiceMode" data-value="flash">
              <text>闪现模式</text>
              <text class="mode-btn-sub">Disappear</text>
            </view>
          </view>
        </view>

        <view class="setting-section">
          <view class="setting-row">
            <text>重复练习次数</text>
            <text class="setting-value">{{settings.repeatCount}}</text>
          </view>
          <slider min="1" max="10" step="1" value="{{settings.repeatCount}}" bindchange="updateSetting" data-key="repeatCount" activeColor="#fad0c4" block-size="20"/>
        </view>

        <view class="setting-section">
          <text class="section-title">键盘显示</text>
          <view class="mode-toggles">
            <view class="mode-btn {{settings.keyboardVisualMode === 'korean' ? 'active' : ''}}" bindtap="updateSetting" data-key="keyboardVisualMode" data-value="korean">
              <text>韩文在上</text>
              <text class="mode-btn-sub">KR / EN</text>
            </view>
            <view class="mode-btn {{settings.keyboardVisualMode === 'english' ? 'active' : ''}}" bindtap="updateSetting" data-key="keyboardVisualMode" data-value="english">
              <text>英文在上</text>
              <text class="mode-btn-sub">EN / KR</text>
            </view>
            <view class="mode-btn {{settings.keyboardVisualMode === 'korean_hide_english' ? 'active' : ''}}" bindtap="updateSetting" data-key="keyboardVisualMode" data-value="korean_hide_english">
              <text>仅韩文</text>
              <text class="mode-btn-sub">KR Only</text>
            </view>
            <view class="mode-btn {{settings.keyboardVisualMode === 'english_only' ? 'active' : ''}}" bindtap="updateSetting" data-key="keyboardVisualMode" data-value="english_only">
              <text>仅英文</text>
              <text class="mode-btn-sub">EN Only</text>
            </view>
          </view>
        </view>

        <!-- <view class="setting-section">
          <view class="setting-row">
            <text>自动倒计时</text>
            <switch checked="{{settings.enableTimer}}" color="#fad0c4" bindchange="toggleSetting" data-key="enableTimer"/>
          </view>
          <view wx:if="{{settings.enableTimer}}" class="slider-container">
            <view class="setting-row">
              <text class="sub-label">倒计时时长</text>
              <text class="setting-value">{{settings.timerDuration}}秒</text>
            </view>
            <slider min="3" max="30" step="1" value="{{settings.timerDuration}}" bindchange="updateSetting" data-key="timerDuration" activeColor="#fad0c4" block-size="20"/>
          </view>
        </view> -->

        <view class="setting-section">
          <text class="section-title">卡片内容</text>
          <view class="content-toggles">
            <view class="toggle-btn {{settings.cardShowWord ? 'active' : ''}}" bindtap="toggleSetting" data-key="cardShowWord">
              <text>显示单词</text>
              <view class="toggle-indicator"></view>
            </view>
            <view class="toggle-btn {{settings.cardShowMeaning ? 'active' : ''}}" bindtap="toggleSetting" data-key="cardShowMeaning">
              <text>显示释义</text>
              <view class="toggle-indicator"></view>
            </view>
          </view>
        </view>

        <view class="setting-section" wx:if="{{settings.practiceMode === 'flash'}}">
          <view class="setting-row">
            <text>闪现时长</text>
            <text class="setting-value">{{settings.flashDuration}}ms</text>
          </view>
          <slider min="200" max="3000" step="100" value="{{settings.flashDuration}}" bindchange="updateSetting" data-key="flashDuration" activeColor="#fad0c4" block-size="20"/>
        </view>

        <view class="setting-section">
          <text class="section-title">功能选项</text>

          <!-- <view class="setting-item" bindtap="toggleSetting" data-key="autoCheckSpelling">
            <text>自动检查拼写</text>
            <switch checked="{{settings.autoCheckSpelling}}" color="#fad0c4" bindchange="toggleSetting" catchtap="preventBubble" data-key="autoCheckSpelling"/>
          </view> -->

          <view class="setting-item" bindtap="toggleSetting" data-key="enableKeyboardHint">
            <text>键盘提示</text>
            <switch checked="{{settings.enableKeyboardHint}}" color="#fad0c4" bindchange="toggleSetting" catchtap="preventBubble" data-key="enableKeyboardHint"/>
          </view>

          <view class="setting-item" bindtap="toggleSetting" data-key="autoPronounce">
            <text>自动朗读单词</text>
            <switch checked="{{settings.autoPronounce}}" color="#fad0c4" bindchange="toggleSetting" catchtap="preventBubble" data-key="autoPronounce"/>
          </view>

          <view class="setting-item" bindtap="toggleSetting" data-key="pronounceMeaning">
            <text>朗读中文释义</text>
            <switch checked="{{settings.pronounceMeaning}}" color="#fad0c4" bindchange="toggleSetting" catchtap="preventBubble" data-key="pronounceMeaning"/>
          </view>

          <view class="setting-item" bindtap="toggleSetting" data-key="autoPlaySentence">
            <text>自动朗读例句</text>
            <switch checked="{{settings.autoPlaySentence}}" color="#fad0c4" bindchange="toggleSetting" catchtap="preventBubble" data-key="autoPlaySentence"/>
          </view>

        </view>
      </scroll-view>
    </view>
  </view>

  <canvas type="2d" id="shareCanvas" style="position: absolute; left: -9999px; top: 0; width: 375px; height: 300px;"></canvas>

  <!-- Update Popup -->
  <view class="modal-overlay center {{showUpdatePopup ? 'show' : ''}}" catchtouchmove="preventScroll">
    <view class="modal-content {{settings.darkMode ? 'dark' : ''}}">
      <view class="modal-header">
        <text class="modal-title">更新说明</text>
        <view class="modal-close" bindtap="closeUpdatePopup">✕</view>
      </view>
      <view class="modal-body" style="padding: 20px;">
        <view style="margin-bottom: 15px; font-weight: bold; font-size: 16px;">v4.3 全新上线！</view>
        <view style="line-height: 1.8; color: #64748b; font-size: 14px;">
          <view>1. 卡片左上角F模式</view>
          <view>2. 点击单词 新增例句</view>
          <view>3. 新增写作矫正模式</view>
          <view>待更新：拍照识别</view>
        </view>
        <button bindtap="closeUpdatePopup" style="margin-top: 25px; width: 100%; background: #6366f1; color: white; border-radius: 12px; font-weight: 500;">开始体验</button>
      </view>
    </view>
  </view>

  <!-- Nagging Mode Overlay -->
  <view class="nagging-overlay" wx:if="{{isNaggingMode}}" catchtouchmove="preventScroll" bindtap="toggleSetting" data-key="naggingMode">
    
    <!-- Toggle Style Button -->
    <view class="nagging-style-switch" catchtap="toggleNaggingStyle">
        <text>{{naggingStyle === 'scatter' ? '切换:文章模式' : '切换:散落模式'}}</text>
    </view>

    <!-- SCATTER MODE -->
    <block wx:if="{{naggingStyle === 'scatter'}}">
        <view class="nagging-bg">
            <block wx:for="{{naggingItems}}" wx:key="id">
                <view class="nagging-bg-item" 
                        style="top:{{item.top}}%; left:{{item.left}}%; font-size:{{item.fontSize}}px; opacity:0; --rotate:{{item.rotate}}deg">
                        {{item.word}}
                </view>
            </block>
        </view>
        <view class="nagging-center">
            <view class="nagging-cn-main">{{currentWord.meaning}}</view>
        </view>
    </block>

    <!-- FLOW MODE -->
    <block wx:if="{{naggingStyle === 'flow'}}">
        <scroll-view scroll-y class="nagging-flow-scroll" scroll-into-view="item-{{naggingItems.length > 0 ? naggingItems.length - 1 : ''}}">
            <view class="nagging-flow-container">
                <view class="nagging-flow-title">【{{currentWord.meaning}}】</view>
                <view class="nagging-flow-content">
                    <block wx:for="{{naggingItems}}" wx:key="id">
                        <text class="nagging-flow-word" id="item-{{index}}">{{item.word}}</text>
                    </block>
                </view>
            </view>
        </scroll-view>
    </block>

    <view class="nagging-tip">点击任意处退出唠叨模式</view>
  </view>
</view>
