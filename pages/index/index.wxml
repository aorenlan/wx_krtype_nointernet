<wxs module="utils">
module.exports = {
  getCharClass: function(status, char) {
    if (status === 'done') return 'text-green';
    if (status === 'active') {
       return char === ' ' ? 'space-active' : 'text-yellow';
    }
    return 'text-gray';
  },
  getDisplayChar: function(char) {
    return char;
  },
  getKeyClass: function(isDone, isCurrent) {
    if (isDone) return 'jamo-done';
    if (isCurrent) return 'jamo-current';
    return 'jamo-future';
  }
};
</wxs>

<view class="container" style="padding-top: {{safeArea.top}}px; padding-bottom: {{safeArea.bottom}}px">
  
  <!-- Decorative Background -->
  <view class="deco-bg">
     <!-- Top Right Shape -->
     <view class="deco-shape top-right">
        <view class="deco-grid">
           <block wx:for="{{decoTop}}" wx:key="index">
             <view class="deco-key"></view>
           </block>
        </view>
     </view>
      <!-- Bottom Left Shape -->
      <view class="deco-shape bottom-left">
        <view class="deco-grid">
           <block wx:for="{{decoBottom}}" wx:key="index">
             <view class="deco-key"></view>
           </block>
        </view>
     </view>
  </view>

  <!-- Navbar -->
  <view class="nav-bar">
    <view wx:if="{{mode !== 'menu'}}" class="back-btn" bindtap="goBack">
      <view class="back-icon-box">
        <image class="back-icon-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBvbHlsaW5lIHBvaW50cz0iMTUgMTggOSAxMiAxNSA2Ij48L3BvbHlsaW5lPjwvc3ZnPg=="></image>
      </view>
    </view>
    <view class="nav-title">{{mode === 'menu' ? '' : (mode === 'custom' ? 'è‡ªå®šä¹‰' : 'ç»ƒä¹ ä¸­')}}</view>
  </view>

  <!-- Menu Mode -->
  <view wx:if="{{mode === 'menu'}}" class="menu-container fade-in">
    <view class="header-section">
      <view class="badge">PRACTICE MODE</view>
      <view class="main-title">éŸ©è¯­æ‰“å­—ç»ƒä¹ </view>
      <view class="sub-title-box">
        <view class="slogan-line">
          <text>3å¤©å‘Šåˆ«</text>
          <text class="highlight-red">éŸ©è¯­è¾“å…¥å¡é¡¿</text>
          <text>ï¼</text>
        </view>
        <view class="slogan-line">
          <text>ä¸“æ²»</text>
          <text class="highlight-yellow">â€˜æƒ³æ‰“å´ä¸ä¼šæ‹¼â€™</text>
          <text>çš„åˆå­¦è€…</text>
        </view>
      </view>
    </view>
    
    <view class="menu-list">
      <button class="menu-item accent" bindtap="startStarNicknames">
        <view class="menu-content">
          <view class="menu-text">ğŸ”¥ æ˜æ˜Ÿä¸“ç»ƒ</view>
          <view class="menu-sub">Star Nicknames</view>
        </view>
        <view class="menu-icon">ğŸŒŸ</view>
      </button>

      <button class="menu-item success" bindtap="startSupportWords">
        <view class="menu-content">
          <view class="menu-text">ğŸ¤ åº”æ´å¼¹å¹•</view>
          <view class="menu-sub">Cheering Words</view>
        </view>
        <view class="menu-icon">ğŸ“£</view>
      </button>

      <button class="menu-item warning" bindtap="startDrama">
        <view class="menu-content">
          <view class="menu-text">ğŸ¬ éŸ©å‰§ç»å…¸</view>
          <view class="menu-sub">K-Drama Lines</view>
        </view>
        <view class="menu-icon">ğŸ­</view>
      </button>

      <button class="menu-item primary" bindtap="startBeginner">
        <view class="menu-content">
          <view class="menu-text">åˆçº§å•è¯</view>
          <view class="menu-sub">Beginner Words & Basics</view>
        </view>
        <view class="menu-icon">ğŸ£</view>
      </button>

      <button class="menu-item secondary" bindtap="startSentences">
        <view class="menu-content">
          <view class="menu-text">å¸¸ç”¨çŸ­å¥</view>
          <view class="menu-sub">Simple Sentences</view>
        </view>
        <view class="menu-icon">ğŸ’¬</view>
      </button>

      <button class="menu-item outline" bindtap="startCustom">
        <view class="menu-content">
          <view class="menu-text">è‡ªå®šä¹‰è¾“å…¥</view>
          <view class="menu-sub">Custom Practice</view>
        </view>
        <view class="menu-icon">âœï¸</view>
      </button>
    </view>

    <view class="footer">
      <text>Practice makes perfect</text>
    </view>
  </view>

  <!-- Custom Input Mode -->
  <view wx:if="{{mode === 'custom'}}" class="custom-container fade-in">
    <view class="card">
      <view class="input-label">è¯·è¾“å…¥éŸ©è¯­æ–‡æœ¬ / Enter Korean Text</view>
      <textarea 
        class="custom-textarea" 
        bindinput="handleCustomInput" 
        value="{{customInputText}}"
        placeholder="åœ¨æ­¤è¾“å…¥..."
        maxlength="100"
      ></textarea>
      <view class="error-msg" wx:if="{{errorMessage}}">{{errorMessage}}</view>
      
      <view class="count-control">
        <view class="count-label">ç»ƒä¹ æ¬¡æ•° / Repetitions</view>
        <view class="stepper">
          <view class="stepper-btn minus" bindtap="decreaseCount">-</view>
          <view class="count-value">x{{practiceCount}}</view>
          <view class="stepper-btn plus" bindtap="increaseCount">+</view>
        </view>
        <view class="count-hint">å¯ä¿®æ”¹ç»ƒä¹ æ¬¡æ•°</view>
      </view>

      <button class="start-btn" bindtap="submitCustom">å¼€å§‹ç»ƒä¹ </button>
    </view>
  </view>

  <!-- Typing Mode -->
  <view wx:if="{{mode === 'typing'}}" class="typing-container fade-in {{isTopAdVisible ? 'has-ad' : ''}}">
    <!-- Custom Ad -->
    <view class="ad-container">
      <ad-custom unit-id="adunit-63b6149bfd4cd62b" bindload="adLoad" binderror="adError" bindclose="adClose"></ad-custom>
    </view>

    <!-- Top Info -->
    <view class="status-bar">
      <view class="progress-pill">
        <text class="progress-text">{{currentItemIndex + 1}} / {{items.length}}</text>
      </view>

      <view class="mini-controls">
        <view class="icon-btn" bindtap="prevItem" hover-class="icon-hover">
          <image class="icon-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWxpbmUgcG9pbnRzPSIxNSAxOCA5IDEyIDE1IDYiPjwvcG9seWxpbmU+PC9zdmc+"></image>
        </view>
        
        <button class="icon-btn share-btn-reset" open-type="share" hover-class="icon-hover">
           <image class="icon-img small" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxOCIgY3k9IjUiIHI9IjMiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjYiIGN5PSIxMiIgcj0iMyI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTgiIGN5PSIxOSIgcj0iMyI+PC9jaXJjbGU+PGxpbmUgeDE9IjguNTkiIHkxPSIxMy41MSIgeDI9IjE1LjQyIiB5Mj0iMTcuNDkiPjwvbGluZT48bGluZSB4MT0iMTUuNDEiIHkxPSI2LjUxIiB4Mj0iOC41OSIgeTI9IjEwLjQ5Ij48L2xpbmU+PC9zdmc+"></image>
        </button>

        <view class="icon-btn" bindtap="nextItem" hover-class="icon-hover">
          <image class="icon-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWxpbmUgcG9pbnRzPSI5IDE4IDE1IDEyIDkgNiI+PC9wb2x5bGluZT48L3N2Zz4="></image>
        </view>
      </view>
    </view>

    <!-- Target Display -->
    <view class="display-area">
      <view class="translation">{{typingState.targetTranslation}}</view>
      
      <view class="text-scroll-wrapper">
        <view class="fade-mask left"></view>
        <view class="fade-mask right"></view>
        
        <scroll-view 
          class="text-scroll" 
          scroll-x="{{true}}" 
          scroll-with-animation="{{true}}"
          scroll-left="{{scrollLeft}}"
          enable-flex="{{true}}"
        >
          <view class="scroll-content">
             <!-- Extra padding at start to center first char -->
             <view id="start-padding" class="start-padding"></view>
             <block wx:for="{{displayNodes}}" wx:key="index">
                <!-- Word -->
                <view wx:if="{{item.type === 'word'}}" class="word-wrapper">
                   <block wx:for="{{item.chars}}" wx:key="idx" wx:for-item="charItem">
                      <text id="char-{{charItem.globalIndex}}" class="char-block {{utils.getCharClass(charItem.status, charItem.char)}}">{{utils.getDisplayChar(charItem.char)}}</text>
                   </block>
                </view>
                <!-- Space -->
                <view wx:else class="space-wrapper">
                   <text id="char-{{item.char.globalIndex}}" class="char-block {{utils.getCharClass(item.char.status, item.char.char)}}">{{utils.getDisplayChar(item.char.char)}}</text>
                </view>
             </block>
             <!-- Extra padding at end to allow last char to scroll to center -->
             <view class="end-padding"></view>
          </view>
        </scroll-view>
      </view>

      <!-- Jamo Breakdown for Active Char -->
      <view class="jamo-hint-container">
        <view class="hint-content-wrapper">
          <block wx:if="{{activeJamos.length > 0}}">
            <view class="jamo-hint-box">
              <block wx:for="{{activeJamos}}" wx:key="index">
                <text class="jamo-char {{utils.getKeyClass(item.isDone, item.isCurrent)}}">{{item.char}}</text>
              </block>
            </view>
          </block>
          <block wx:else>
            <view class="jamo-hint-placeholder">Done!</view>
          </block>
        </view>
        
        <!-- Keyboard Mode Toggle (Moved here) -->
        <view class="mode-toggle" bindtap="toggleVisualMode">
          <text>{{preferredKeyboardMode === 'korean' ? 'í•œ/A' : 'EN/A'}}</text>
        </view>
      </view>
    </view>

    <!-- Keyboard -->
    <view class="keyboard-wrapper">
      <keyboard 
        id="keyboard"
        nextKeyToPress="{{typingState.nextKey}}"
        isShiftActive="{{typingState.isShiftActive}}"
        visualMode="{{preferredKeyboardMode}}"
        bind:keyPress="onVirtualKeyPress"
      />
    </view>
  </view>

</view>
