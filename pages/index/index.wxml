<wxs module="utils">
module.exports = {
  getCharClass: function(status, char) {
    if (status === 'done') return 'text-green';
    if (status === 'active') {
       return char === ' ' ? 'space-active' : 'text-yellow';
    }
    return 'text-gray';
  },
  getDisplayChar: function(char) {
    return char;
  },
  getKeyClass: function(isDone, isCurrent) {
    if (isDone) return 'jamo-done';
    if (isCurrent) return 'jamo-current';
    return 'jamo-future';
  }
};
</wxs>

<view wx:if="{{!isRedirecting}}" class="container" style="padding-top: {{safeArea.top}}px; padding-bottom: {{safeArea.bottom}}px">
  
  <!-- Decorative Background -->
  <view class="deco-bg">
     <!-- Top Right Shape -->
     <view class="deco-shape top-right">
        <view class="deco-grid">
           <block wx:for="{{decoTop}}" wx:key="index">
             <view class="deco-key"></view>
           </block>
        </view>
     </view>
      <!-- Bottom Left Shape -->
      <view class="deco-shape bottom-left">
        <view class="deco-grid">
           <block wx:for="{{decoBottom}}" wx:key="index">
             <view class="deco-key"></view>
           </block>
        </view>
     </view>
  </view>

  <!-- Navbar -->
  <view class="nav-bar" style="height: {{navBar.totalHeight}}px; padding-top: {{navBar.paddingTop}}px; box-sizing: border-box;">
    <view class="nav-content">
      <view wx:if="{{mode !== 'menu' && mode !== 'typing'}}" class="back-btn" bindtap="goBack">
        <view class="back-icon-box">
          <image class="back-icon-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBvbHlsaW5lIHBvaW50cz0iMTUgMTggOSAxMiAxNSA2Ij48L3BvbHlsaW5lPjwvc3ZnPg=="></image>
        </view>
      </view>
      <view class="nav-title">{{mode === 'menu' ? '' : (mode === 'custom' ? 'è‡ªå®šä¹‰' : 'ç»ƒä¹ ä¸­')}}</view>
    </view>
  </view>

  <!-- Menu Mode -->
  <view wx:if="{{mode === 'menu'}}" class="menu-container fade-in">
    <view class="contact-wrapper">
      <view class="contact-btn" bindtap="toggleContactModal">?</view>
      <view class="contact-toast fade-in" wx:if="{{showContactToast}}" bindtap="closeContactToast">
        <text>è”ç³»ä½œè€… / åé¦ˆ</text>
        <view class="toast-arrow"></view>
      </view>
    </view>

    <view class="header-section">
      <view class="badge">PRACTICE MODE</view>
      <view class="main-title">éŸ©è¯­æ‰“å­—ç»ƒä¹ </view>
      <view class="sub-title-box">
        <view class="slogan-line">
          <text>3å¤©å‘Šåˆ«</text>
          <text class="highlight-red">éŸ©è¯­è¾“å…¥å¡é¡¿</text>
          <text>ï¼</text>
        </view>
        <view class="slogan-line">
          <text>ä¸“æ²»</text>
          <text class="highlight-yellow">â€˜æƒ³æ‰“å´ä¸ä¼šæ‹¼â€™</text>
          <text>çš„åˆå­¦è€…</text>
        </view>
      </view>
    </view>
    
    <view class="menu-list">
      <button class="menu-item accent" bindtap="startStarNicknames">
        <view class="menu-content">
          <view class="menu-text">ğŸ”¥ æ˜æ˜Ÿä¸“ç»ƒ</view>
          <view class="menu-sub">Star Nicknames</view>
        </view>
        <view class="menu-icon">ğŸŒŸ</view>
      </button>

      <button class="menu-item success" bindtap="startSupportWords">
        <view class="menu-content">
          <view class="menu-text">ğŸ¤ åº”æ´å¼¹å¹•</view>
          <view class="menu-sub">Cheering Words</view>
        </view>
        <view class="menu-icon">ğŸ“£</view>
      </button>

      <button class="menu-item warning" bindtap="startDrama">
        <view class="menu-content">
          <view class="menu-text">ğŸ¬ éŸ©å‰§ç»å…¸</view>
          <view class="menu-sub">K-Drama Lines</view>
        </view>
        <view class="menu-icon">ğŸ­</view>
      </button>

      <button class="menu-item primary" bindtap="startBeginner">
        <view class="menu-content">
          <view class="menu-text">åˆçº§å•è¯</view>
          <view class="menu-sub">Beginner Words & Basics</view>
        </view>
        <view class="menu-icon">ğŸ£</view>
      </button>

      <button class="menu-item secondary" bindtap="startSentences">
        <view class="menu-content">
          <view class="menu-text">å¸¸ç”¨çŸ­å¥</view>
          <view class="menu-sub">Simple Sentences</view>
        </view>
        <view class="menu-icon">ğŸ’¬</view>
      </button>

      <button class="menu-item popular" bindtap="startPopular">
        <view class="menu-content">
          <view class="menu-text">ğŸµ æµè¡Œçƒ­æ›²</view>
          <view class="menu-sub">K-Pop Hits</view>
        </view>
        <view class="menu-icon">ğŸ§</view>
      </button>
    </view>

    <view class="action-grid">
      <view class="custom-entry">
        <button class="menu-item outline" bindtap="startCustom">
          <view class="menu-content">
            <view class="menu-text">è‡ªå®šä¹‰è¾“å…¥</view>
            <view class="menu-sub">Custom</view>
          </view>
          <view class="menu-icon">âœï¸</view>
        </button>
      </view>

      <view class="pc-entry">
        <button class="menu-item outline pc-btn" bindtap="handleCopyPC">
          <view class="menu-content centered">
            <view class="menu-text small-text">
              <view>åœ¨æµè§ˆå™¨ä½¿ç”¨</view>
              <view>ç‚¹å‡»å¤åˆ¶é“¾æ¥</view>
            </view>
            <view class="menu-sub pc-sub">éœ€å®Œæ•´è§‚çœ‹å¹¿å‘Š</view>
          </view>
          <view class="hand-guide-box">
             <image class="hand-icon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTkgMTEuMjRWNy41QzkgNi4xMiAxMC4xMiA1IDExLjUgNVMxNCA2LjEyIDE0IDcuNXYzLjc0YzEuMjEtLjgxIDItMi4xOCAyLTMuNzRDMTYgNS4wMSAxMy45OSAzIDExLjUgM1M3IDUuMDEgNyA3LjVjMCAxLjU2Ljc5IDIuOTMgMiAzLjc0em05Ljg0IDQuNjNsLTQuNTQtMi4yNmMtLjE3LS4wNy0uMzUtLjExLS41NC0uMTFIMTN2LTZjMC0uODMtLjY3LTEuNS0xLjUtMS41UzEwIDYuNjcgMTAgNy41djEwLjc0bC0zLjQzLS43MmMtLjA4LS4wMS0uMTUtLjAzLS4yNC0uMDMtLjMxIDAtLjU5LjEzLS43OS4zM2wtLjc5LjggNC45NCA0Ljk0Yy4yNy4yNy42NS40NCAxLjA2LjQ0aDYuNzljLjc1IDAgMS4zMy0uNTUgMS40NC0xLjI4bC43NS01LjI3Yy4wMS0uMDcuMDItLjE0LjAyLS4yIDAtLjYyLS4zOC0xLjE2LS45MS0xLjM4eiIvPjwvc3ZnPg=="></image>
          </view>
        </button>
      </view>
    </view>

    <view class="footer">
      <text>Practice makes perfect</text>
    </view>
  </view>

  <!-- Custom Input Mode -->
  <view wx:if="{{mode === 'custom'}}" class="custom-container fade-in">
    <view class="card">
      <view class="input-label">è¯·è¾“å…¥éŸ©è¯­æ–‡æœ¬ / Enter Korean Text</view>
      <textarea 
        class="custom-textarea" 
        bindinput="handleCustomInput" 
        value="{{customInputText}}"
        placeholder="è¯·æŠŠéœ€è¦ç»ƒä¹ çš„è¯­å¥å¤åˆ¶åˆ°æ­¤å¤„"
        maxlength="100"
      ></textarea>
      <view class="error-msg" wx:if="{{errorMessage}}">{{errorMessage}}</view>
      
      <view class="count-control">
        <view class="count-label">ç»ƒä¹ æ¬¡æ•° / Repetitions</view>
        <view class="stepper">
          <view class="stepper-btn minus" bindtap="decreaseCount">-</view>
          <view class="count-value">x{{practiceCount}}</view>
          <view class="stepper-btn plus" bindtap="increaseCount">+</view>
        </view>
        <view class="count-hint">å¯ä¿®æ”¹ç»ƒä¹ æ¬¡æ•°</view>
      </view>

      <view class="sample-btn-box">
        <view class="sample-btn" bindtap="fillSampleText">ç”Ÿæˆæ ·ä¾‹ (Generate Sample)</view>
      </view>

      <button class="start-btn" bindtap="submitCustom">å¼€å§‹ç»ƒä¹ </button>
    </view>

    <!-- Custom Mode Ad -->
    <!-- Removed by user request -->
  </view>

  <!-- Typing Mode -->
  <view wx:if="{{mode === 'typing'}}" class="typing-container fade-in {{isTopAdVisible ? 'has-ad' : ''}}">
    <!-- Custom Ad -->
    <ad-custom wx:if="{{!adsDisabled}}" unit-id="adunit-63b6149bfd4cd62b" bindload="adLoad" binderror="adError" bindclose="adClose"></ad-custom>

    <!-- Top Info -->
    <view class="status-bar">
      <view class="progress-pill">
        <text class="progress-text">{{currentItemIndex + 1}} / {{items.length}}</text>
      </view>

      <view class="mini-controls">
        <view class="icon-btn" bindtap="goBack" hover-class="icon-hover">
          <image class="icon-img small" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWxpbmUgcG9pbnRzPSIxNSAxOCA5IDEyIDE1IDYiPjwvcG9seWxpbmU+PC9zdmc+"></image>
        </view>
        <!-- Settings Button -->
        <view class="settings-wrapper">
        <view class="icon-btn" bindtap="showSettings" hover-class="icon-hover">
           <image class="icon-img small" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIzIj48L2NpcmNsZT48cGF0aCBkPSJNMTkuNCAxNWExLjY1IDEuNjUgMCAwIDAgLjMzIDEuODJsLjA2LjA2YTIgMiAwIDAgMSAwIDIuODMgMiAyIDAgMCAxLTIuODMgMGwtLjA2LS4wNmExLjY1IDEuNjUgMCAwIDAtMS44Mi0uMzMgMS42NSAxLjY1IDAgMCAwLTEgMS41MVYyMWEyIDIgMCAwIDEtMiAyIDIgMiAwIDAgMS0yLTJ2LS4wOUExLjY1IDEuNjUgMCAwIDAgOSAxOS40YTEuNjUgMS42NSAwIDAgMC0xLjgyLjMzbC0uMDYuMDZhMiAyIDAgMCAxLTIuODMgMCAyIDIgMCAwIDEgMC0yLjgzbC4wNi0uMDZhMS42NSAxLjY1IDAgMCAwIC4zMy0xLjgyIDEuNjUgMS42NSAwIDAgMC0xLjUxLTFIM2EyIDIgMCAwIDEtMi0yIDIgMiAwIDAgMSAyLTJoLjA5QTEuNjUgMS42NSAwIDAgMCA0LjYgOWExLjY1IDEuNjUgMCAwIDAtLjMzLTEuODJsLS4wNi0uMDZhMiAyIDAgMCAxIDAtMi44MyAyIDIgMCAwIDEgMi44MyAwbC4wNi4wNmExLjY1IDEuNjUgMCAwIDAgMS44Mi4zM0g5YTEuNjUgMS42NSAwIDAgMCAxLTEuNTFWM2EyIDIgMCAwIDEgMi0yIDIgMiAwIDAgMSAyIDJ2LjA5YTEuNjUgMS42NSAwIDAgMCAxIDEuNTEgMS42NSAxLjY1IDAgMCAwIDEuODItLjMzbC4wNi0uMDZhMiAyIDAgMCAxIDIuODMgMCAyIDIgMCAwIDEgMCAyLjgzbC0uMDYuMDZhMS42NSAxLjY1IDAgMCAwLS4zMyAxLjgyVjlhMS42NSAxLjY1IDAgMCAwIDEuNTEgMUgyMWEyIDIgMCAwIDEgMiAyIDIgMiAwIDAgMS0yIDJoLS4wOWExLjY1IDEuNjUgMCAwIDAtMS41MSAxeiI+PC9wYXRoPjwvc3ZnPg=="></image>
        </view>
          
          <view class="tooltip-bubble" wx:if="{{showTooltip}}" catchtap="closeTooltip">
            <text>å¯å¼€å¯è‡ªåŠ¨æœ—è¯»</text>
          </view>
        </view>

        <!-- Play Button -->
        <view class="icon-btn" bindtap="playCurrentAudio" hover-class="icon-hover" style="{{!canPlayAudio ? 'opacity: 0.3' : ''}}">
           <image class="icon-img small" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWdvbiBwb2ludHM9IjExIDUgNiA5IDIgOSAyIDE1IDYgMTUgMTEgMTkiPjwvcG9seWdvbj48cGF0aCBkPSJNMTUuNTQgOC40NmEzIDMgMCAwIDEgMCA3LjA3Ij48L3BhdGg+PHBhdGggZD0iTTE5LjA3IDQuOTNhMTAgMTAgMCAwIDEgMCAxNC4xNCI+PC9wYXRoPjwvc3ZnPg=="></image>
        </view>
        
        <button class="icon-btn share-btn-reset" open-type="share" hover-class="icon-hover">
           <image class="icon-img small" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxOCIgY3k9IjUiIHI9IjMiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjYiIGN5PSIxMiIgcj0iMyI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTgiIGN5PSIxOSIgcj0iMyI+PC9jaXJjbGU+PGxpbmUgeDE9IjguNTkiIHkxPSIxMy41MSIgeDI9IjE1LjQyIiB5Mj0iMTcuNDkiPjwvbGluZT48bGluZSB4MT0iMTUuNDEiIHkxPSI2LjUxIiB4Mj0iOC41OSIgeTI9IjEwLjQ5Ij48L2xpbmU+PC9zdmc+"></image>
        </button>
      </view>
    </view>

    <!-- Target Display -->
    <view class="display-area">
      <view class="translation-container">
        <view class="translation">{{typingState.targetTranslation}}</view>
      </view>
      
      <view class="display-row">
        <!-- Left Nav -->
        <view class="nav-strip left" bindtap="prevItem" hover-class="icon-hover">
           <image class="nav-icon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWxpbmUgcG9pbnRzPSIxNSAxOCA5IDEyIDE1IDYiPjwvcG9seWxpbmU+PC9zdmc+"></image>
        </view>

        <view class="text-area-container">
          <!-- Normal Scroll View -->
          <view class="text-scroll-wrapper" wx:if="{{!isTextExpanded}}">
            <view class="fade-mask left"></view>
            <view class="fade-mask right"></view>
            
            <scroll-view 
              class="text-scroll" 
              scroll-x="{{true}}" 
              scroll-with-animation="{{true}}"
              scroll-left="{{scrollLeft}}"
              enable-flex="{{true}}"
              show-scrollbar="{{false}}"
            >
              <view class="scroll-content">
                 <!-- Extra padding at start to center first char -->
                 <view id="start-padding" class="start-padding"></view>
                 <block wx:for="{{displayNodes}}" wx:key="index">
                    <!-- Word -->
                    <view wx:if="{{item.type === 'word'}}" class="word-wrapper">
                       <block wx:for="{{item.chars}}" wx:key="idx" wx:for-item="charItem">
                          <text 
                            id="char-{{charItem.globalIndex}}" 
                            class="char-block {{utils.getCharClass(charItem.status, charItem.char)}}"
                            style="{{charItem.status === 'active' ? 'background: linear-gradient(to right, #34d399 ' + charItem.progress + '%, #ffffff ' + charItem.progress + '%); -webkit-background-clip: text; color: transparent;' : ''}}"
                          >{{utils.getDisplayChar(charItem.char)}}</text>
                       </block>
                    </view>
                    <!-- Space -->
                    <view wx:else class="space-wrapper">
                       <text id="char-{{item.char.globalIndex}}" class="char-block {{utils.getCharClass(item.char.status, item.char.char)}}">{{utils.getDisplayChar(item.char.char)}}</text>
                    </view>
                 </block>
                 <!-- Extra padding at end to allow last char to scroll to center -->
                 <view class="end-padding"></view>
              </view>
            </scroll-view>
          </view>

          <!-- Expanded View (Full Text) -->
          <block wx:else>
            <!-- Removed fade masks for clearer visibility -->
            <!-- <view class="fade-mask top"></view> -->
            <!-- <view class="fade-mask bottom"></view> -->
            <scroll-view 
              class="expanded-text-view {{typingState.targetText.length > 25 ? 'tiny-text' : (typingState.targetText.length > 12 ? 'small-text' : '')}}" 
              scroll-y="{{typingState.targetText.length > 60}}"
              enhanced="{{true}}"
              show-scrollbar="{{false}}"
              enable-flex="{{true}}"
              scroll-into-view="expanded-char-{{activeCharIndex}}"
              scroll-with-animation="{{true}}"
            >
               <block wx:for="{{displayNodes}}" wx:key="index">
                  <view wx:if="{{item.type === 'word'}}" class="word-wrapper">
                     <block wx:for="{{item.chars}}" wx:key="idx" wx:for-item="charItem">
                        <text 
                          id="expanded-char-{{charItem.globalIndex}}"
                          class="char-block {{utils.getCharClass(charItem.status, charItem.char)}}"
                          style="{{charItem.status === 'active' ? 'background: linear-gradient(to right, #34d399 ' + charItem.progress + '%, #ffffff ' + charItem.progress + '%); -webkit-background-clip: text; color: transparent;' : ''}}"
                        >{{utils.getDisplayChar(charItem.char)}}</text>
                     </block>
                  </view>
                  <view wx:else class="space-wrapper">
                     <text 
                       id="expanded-char-{{item.char.globalIndex}}"
                       class="char-block {{utils.getCharClass(item.char.status, item.char.char)}}"
                     >{{utils.getDisplayChar(item.char.char)}}</text>
                  </view>
               </block>
            </scroll-view>
          </block>
        </view>

        <!-- Right Nav -->
        <view class="nav-strip right" bindtap="nextItem" hover-class="icon-hover">
           <image class="nav-icon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWxpbmUgcG9pbnRzPSI5IDE4IDE1IDEyIDkgNiI+PC9wb2x5bGluZT48L3N2Zz4="></image>
        </view>
      </view>
    </view>

    <!-- Jamo Breakdown for Active Char -->
    <view class="jamo-hint-container">
      <view class="hint-content-wrapper">
        <block wx:if="{{activeJamos.length > 0}}">
          <view class="jamo-hint-box">
            <block wx:for="{{activeJamos}}" wx:key="index">
              <text class="jamo-char {{utils.getKeyClass(item.isDone, item.isCurrent)}}">{{item.char}}</text>
            </block>
          </view>
        </block>
        <block wx:else>
          <view class="jamo-hint-placeholder">Done!</view>
        </block>
      </view>
      
      <!-- Keyboard Mode Toggle (Moved here) -->
      <view class="mode-toggle" bindtap="toggleVisualMode">
        <text>{{preferredKeyboardMode === 'korean' ? 'í•œ/A' : 'EN/A'}}</text>
      </view>
    </view>

    <!-- Keyboard -->
    <view class="keyboard-wrapper">
      <keyboard 
        id="keyboard"
        theme="dark"
        variant="legacy"
        nextKeyToPress="{{typingState.nextKey || ''}}"
        isShiftActive="{{typingState.isShiftActive}}"
        visualMode="{{preferredKeyboardMode}}"
        bind:keyPress="onVirtualKeyPress"
      />
    </view>
  </view>

  <!-- Settings Modal Overlay -->
  <view class="modal-overlay fade-in" wx:if="{{showSettingsModal}}" bindtap="closeSettings">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">è®¾ç½® / Settings</view>
      <view class="modal-body">
        <view class="setting-item">
           <view class="setting-text">
             <text class="setting-title">è‡ªåŠ¨æœ—è¯»</text>
             <text class="setting-desc">ç»ƒä¹ æ—¶è‡ªåŠ¨æ’­æ”¾å•è¯å‘éŸ³</text>
           </view>
           <switch checked="{{autoRead}}" bindchange="onAutoReadChange" color="#6366f1"/>
        </view>
        
        <view class="setting-item" style="margin-top: 20px;">
           <view class="setting-text">
             <text class="setting-title">å§‹ç»ˆå±•å¼€æ–‡æœ¬</text>
             <text class="setting-desc">å¼€å¯åæ–‡æœ¬å°†æ˜¾ç¤ºä¸ºå¤šè¡Œ</text>
           </view>
           <switch checked="{{isTextExpanded}}" bindchange="onExpandTextChange" color="#6366f1"/>
        </view>
      </view>
      <view class="modal-footer">
        <view class="modal-close-btn" bindtap="closeSettings">å…³é—­</view>
      </view>
    </view>
  </view>

  <!-- Contact Modal -->
  <view class="modal-overlay fade-in" wx:if="{{showContactModal}}" bindtap="toggleContactModal">
    <view class="modal-content contact-modal" catchtap="true">
      <view class="modal-header">è”ç³»ä½œè€… / Contact</view>
      <view class="modal-body contact-body">
         <image class="contact-avatar" src="../../images/logo.png" mode="aspectFit" wx:if="{{false}}"></image> <!-- Placeholder if needed -->
         <view class="contact-desc">
           <text>å¦‚æœ‰å»ºè®®æˆ–åé¦ˆï¼Œæˆ–æœ‰è‡ªå·±æƒ³è¦çš„åŠŸèƒ½</text>
           <text>æ¬¢è¿è”ç³»ä½œè€…~</text>
           <text class="contact-sub">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶å¾®ä¿¡å·</text>
         </view>
         <view class="wx-id-box" bindtap="copyContactInfo">
            <text class="wx-label">WeChat ID:</text>
            <text class="wx-value">zaizaikf007</text>
            <view class="copy-icon">ğŸ“‹</view>
         </view>
      </view>
      <view class="modal-footer">
        <view class="modal-close-btn" bindtap="toggleContactModal">å…³é—­</view>
      </view>
    </view>
  </view>

  <!-- Hidden Canvas for Share Image Generation -->
  <canvas type="2d" id="shareCanvas" class="share-canvas" style="position: absolute; left: -9999px; top: 0; width: 500px; height: 400px;"></canvas>

  <!-- New Version Popup -->
  <view class="nv-popup-mask" wx:if="{{showNvPopup}}">
    <view class="nv-popup-content">
      <view class="nv-title">å‘ç°æ–°ç‰ˆæœ¬</view>
      <view class="nv-desc">å…¨æ–°è®¾è®¡çš„ç»ƒä¹ æ¨¡å¼ï¼Œæ˜¯å¦ä½“éªŒï¼Ÿ</view>
      <view class="nv-actions">
        <button class="nv-btn cancel" bindtap="minimizeNvPopup">æš‚ä¸ä½“éªŒ</button>
        <button class="nv-btn confirm" bindtap="enterNewVersion">ç«‹å³ä½“éªŒ</button>
      </view>
    </view>
  </view>

  <!-- Minimized Icon -->
  <view class="nv-minimized" wx:if="{{!showNvPopup && (nvPopupMinimized || hasSeenNvPopup)}}" bindtap="restoreNvPopup" style="top: {{navBar.totalHeight + 28}}px">
    <text>æ–°ç‰ˆ</text>
  </view>

</view>
<view wx:else style="width: 100vw; height: 100vh;"></view>
